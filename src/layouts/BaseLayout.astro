---
/**
 * BaseLayout.astro
 *
 * Layout base del sitio que contiene la estructura HTML común.
 * Incluye Header, Footer y el SearchModal a nivel root.
 *
 * Patrón Portal: SearchModal se renderiza aquí (fuera del Header)
 * para asegurar que position:fixed cubra toda la pantalla.
 *
 * @see src/components/SearchModal.astro - Modal renderizado a nivel root
 * @see src/components/SearchBox.astro - Botón que dispara el modal
 */

import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SearchModal from "../components/SearchModal.astro";
import { t } from "astro-i18n";
import { getSiteUrl, getSiteHost } from "../utils/siteConfig";

interface Props {
  title: string;
  description: string;
  canonicalUrl?: string;
  ogImage?: string;
  pageType?: string;
  structuredData?: Record<string, unknown>[];
}

const {
  title,
  description,
  canonicalUrl,
  ogImage,
  pageType = "WebPage",
  structuredData = [],
} = Astro.props as Props;

// Obtener locale actual usando Astro.currentLocale (API correcta)
const rawLocale = Astro.currentLocale || "en";
const locale = rawLocale.split("-")[0];

// URL base dinámica - detecta ambiente automáticamente
// - Dev: http://localhost:4321
// - Staging: https://ignia.kilowatto.com
// - Production: https://ignia.cloud
const baseUrl = getSiteUrl(Astro);
const currentPath = Astro.url.pathname;
const currentUrl = canonicalUrl || `${baseUrl}${currentPath}`;

// Hostname para resource hints (preconnect/dns-prefetch)
const siteHost = getSiteHost(Astro);

// Traducción del skip link para accesibilidad multi-idioma
const skipToContentLabel = t("layout.skip_link", undefined, { locale });
---

<html lang={locale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Preconnect para mejorar performance de Critical Path -->
    <!-- Hostname dinámico según ambiente (localhost, staging, production) -->
    <link rel="preconnect" href={`https://${siteHost}`} crossorigin />
    <link rel="dns-prefetch" href={`https://${siteHost}`} />

    <link rel="icon" href="/icons/favicon.ico" />
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    {ogImage && <meta property="og:image" content={ogImage} />}
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={pageType} />
    <meta property="og:url" content={currentUrl} />
    <meta property="og:locale" content={locale} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImage && <meta name="twitter:image" content={ogImage} />}

    {
      structuredData.map((schema) => (
        <script type="application/ld+json" set:html={JSON.stringify(schema)} />
      ))
    }
  </head>
  <body class="min-h-screen bg-white text-gray-900">
    <!-- 
      Skip to content link para accesibilidad WCAG 2.2 AA
      Permite a usuarios de teclado y screen readers saltar directamente al contenido principal
      Cumplimiento: arquitecture.md §2 (Accesibilidad WCAG 2.2 AA)
    -->
    <a
      href="#main"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[999] focus:bg-orange-500 focus:text-white focus:px-4 focus:py-2 focus:rounded-lg focus:shadow-lg focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2"
    >
      {skipToContentLabel}
    </a>

    <!-- Header con SearchBox (solo botón) -->
    <Header />

    <!-- Contenido principal de la página -->
    <main id="main" class="min-h-[60vh]">
      <slot />
    </main>

    <!-- Footer del sitio -->
    <Footer />

    <!-- 
      SearchModal - Patrón Portal
      Renderizado aquí (fuera del header) para que position:fixed 
      cubra toda la pantalla sin restricciones del header
    -->
    <SearchModal />
  </body>
</html>
