---
/**
 * LanguageDetection - Sistema de DetecciÃ³n AutomÃ¡tica de Idioma (v1.3 Minimalista)
 *
 * PropÃ³sito:
 * Detecta el idioma preferido del usuario (navegador + geolocalizaciÃ³n) y renderiza
 * el banner minimalista LanguageSuggestionBanner.astro cuando hay mismatch.
 *
 * Arquitectura (OpciÃ³n 1 - HÃ­brida):
 * 1. Renderiza TODOS los banners posibles desde servidor (hidden)
 * 2. JavaScript detecta idioma y muestra el banner correcto
 * 3. Usa componente Astro minimalista (no crea HTML dinÃ¡mico)
 *
 * Fix i18n (v1.3.1):
 * - Carga traducciones directamente desde JSON (no usa t())
 * - Pasa texto pre-traducido como props
 * - Soluciona problema: t() siempre usa currentLocale, no suggestedLanguage
 *
 * Cumplimiento arquitectÃ³nico:
 * - Â§2: JS mÃ­nimo (solo detecciÃ³n, no crea DOM)
 * - Â§5: i18n centralizado (traducciones desde JSON)
 * - Â§12: WCAG AA garantizado (componente Astro)
 * - Â§14: Performance (banners hidden, ~6KB total gzip)
 *
 * @see src/components/LanguageSuggestionBanner.astro
 * @see arquitecture.md Â§2, Â§5, Â§6, Â§12, Â§14
 */

const currentLocale = Astro.currentLocale || "en";
import LanguageSuggestionBanner from "./LanguageSuggestionBanner.astro";

// Cargar traducciones directamente desde JSON
import enTranslations from "../i18n/en.json";
import esTranslations from "../i18n/es.json";
import frTranslations from "../i18n/fr.json";

const translations = {
  en: enTranslations,
  es: esTranslations,
  fr: frTranslations,
};

// Idiomas soportados (para renderizar todos los banners)
const supportedLanguages = ["en", "es", "fr"] as const;
type SupportedLanguage = (typeof supportedLanguages)[number];
---

<!-- 
  Renderizar TODOS los banners posibles (hidden por defecto)
  JavaScript mostrarÃ¡ el correcto segÃºn detecciÃ³n
  
  CRÃTICO: Pasamos traducciones del idioma SUGERIDO (no current)
  Ejemplo: En pÃ¡gina /fr/, banner sugiere ES, usamos traducciones ES
-->{
  supportedLanguages.map((suggestedLang) => {
    if (suggestedLang !== currentLocale) {
      const t =
        translations[suggestedLang as SupportedLanguage].language
          .language_banner;

      return (
        <div
          id={`language-banner-${suggestedLang}`}
          data-suggested-lang={suggestedLang}
          data-current-lang={currentLocale}
          class="hidden"
        >
          <LanguageSuggestionBanner
            suggestedLanguage={suggestedLang}
            currentLanguage={currentLocale}
            translations={{
              aria_label: t.aria_label,
              flag_aria: t.flag_aria,
              message: t.message,
              accept_button: t.accept_button,
              accept_aria: t.accept_aria,
              dismiss_aria: t.dismiss_aria,
              actions_aria: t.actions_aria,
            }}
          />
        </div>
      );
    }
  })
}

<!-- Script minimalista de detecciÃ³n (solo lÃ³gica, no crea DOM) -->
<script>
  /**
   * DetecciÃ³n automÃ¡tica de idioma - v1.3 Minimalista
   *
   * Cambios vs versiÃ³n anterior:
   * - NO crea HTML dinÃ¡micamente (usa componentes pre-renderizados)
   * - Solo muestra/oculta banners existentes
   * - Reduce cÃ³digo de ~233 lÃ­neas a ~80 lÃ­neas (-65%)
   *
   * Flujo:
   * 1. Verificar localStorage (dismissed/accepted)
   * 2. Detectar idioma (navegador â†’ geolocalizaciÃ³n)
   * 3. Mostrar banner pre-renderizado correspondiente
   */

  document.addEventListener("DOMContentLoaded", async () => {
    console.log("[LanguageDetection] ğŸš€ Starting detection...");

    const supportedLanguages = ["en", "es", "fr"];
    const currentLang = document.documentElement.lang?.split("-")[0] || "en";

    console.log(
      `[LanguageDetection] ğŸ“„ Document lang attribute: ${document.documentElement.lang}`
    );
    console.log(`[LanguageDetection] ğŸŒ Current page language: ${currentLang}`);
    console.log(
      `[LanguageDetection] ğŸŒ Browser languages: ${JSON.stringify(navigator.languages)}`
    );

    // Verificar si ya se mostrÃ³/rechazÃ³ la sugerencia
    const dismissed = localStorage.getItem("language-suggestion-dismissed");
    const accepted = localStorage.getItem("language-suggestion-accepted");

    console.log(`[LanguageDetection] ğŸ’¾ localStorage.dismissed: ${dismissed}`);
    console.log(`[LanguageDetection] ğŸ’¾ localStorage.accepted: ${accepted}`);

    if (dismissed || accepted) {
      console.log("[LanguageDetection] â›” Banner already processed, skipping");
      return; // No mostrar si ya fue procesado
    }

    // Verificar que los banners existen en el DOM
    const bannerEn = document.getElementById("language-banner-en");
    const bannerEs = document.getElementById("language-banner-es");
    const bannerFr = document.getElementById("language-banner-fr");
    console.log(
      `[LanguageDetection] ğŸ” Banner elements: EN=${!!bannerEn}, ES=${!!bannerEs}, FR=${!!bannerFr}`
    );

    // Detectar idioma preferido
    let suggestedLang: string | null = null;

    // 1. Detectar por navegador (primario)
    const browserLangs = navigator.languages || [navigator.language];
    console.log(
      `[LanguageDetection] ğŸ” Checking ${browserLangs.length} browser languages...`
    );

    for (const lang of browserLangs) {
      const shortLang = lang.split("-")[0].toLowerCase();
      console.log(`[LanguageDetection]   - Checking: ${lang} â†’ ${shortLang}`);

      if (supportedLanguages.includes(shortLang) && shortLang !== currentLang) {
        suggestedLang = shortLang;
        console.log(
          `[LanguageDetection] âœ… Browser language detected: ${suggestedLang}`
        );
        break;
      } else {
        console.log(
          `[LanguageDetection]   âŒ Skip (supported=${supportedLanguages.includes(shortLang)}, different=${shortLang !== currentLang})`
        );
      }
    }

    // 2. Fallback: Detectar por geolocalizaciÃ³n (secundario)
    if (!suggestedLang) {
      console.log(
        "[LanguageDetection] ğŸŒ No browser match, trying geolocation..."
      );
      try {
        const response = await fetch("https://ipapi.co/json/");
        if (response.ok) {
          const data = await response.json();
          console.log(
            `[LanguageDetection] ğŸ“ Geolocation data: ${JSON.stringify(data)}`
          );

          const countryToLang: Record<string, string> = {
            // EspaÃ±ol
            ES: "es",
            MX: "es",
            AR: "es",
            CO: "es",
            PE: "es",
            CL: "es",
            VE: "es",
            // FrancÃ©s
            FR: "fr",
            BE: "fr",
            CH: "fr",
            CA: "fr",
            LU: "fr",
            // InglÃ©s
            US: "en",
            GB: "en",
            AU: "en",
            NZ: "en",
            IE: "en",
            ZA: "en",
          };

          const geoLang = countryToLang[data.country_code];
          if (
            geoLang &&
            geoLang !== currentLang &&
            supportedLanguages.includes(geoLang)
          ) {
            suggestedLang = geoLang;
            console.log(
              `[LanguageDetection] âœ… Geolocation language detected: ${suggestedLang}`
            );
          } else {
            console.log(
              `[LanguageDetection] âŒ No geolocation match (country=${data.country_code}, lang=${geoLang})`
            );
          }
        }
      } catch (error) {
        console.log(
          "[LanguageDetection] âš ï¸ Geolocation detection failed:",
          error
        );
      }
    }

    // 3. Mostrar banner pre-renderizado si hay sugerencia
    if (suggestedLang) {
      console.log(
        `[LanguageDetection] ğŸ¯ Will show banner for language: ${suggestedLang}`
      );

      const bannerWrapper = document.getElementById(
        `language-banner-${suggestedLang}`
      );

      if (bannerWrapper) {
        console.log(
          `[LanguageDetection] âœ… Banner element found: #language-banner-${suggestedLang}`
        );
        console.log(
          `[LanguageDetection] ğŸ“¦ Banner wrapper classes before: ${bannerWrapper.className}`
        );

        // Paso 1: Quitar hidden del wrapper
        bannerWrapper.classList.remove("hidden");

        console.log(
          `[LanguageDetection] ğŸ“¦ Banner wrapper classes after: ${bannerWrapper.className}`
        );

        // Paso 2: Animar el banner interno despuÃ©s de 1.5s
        setTimeout(() => {
          const innerBanner = bannerWrapper.querySelector(
            "#language-suggestion-banner"
          );
          if (innerBanner) {
            console.log(`[LanguageDetection] ï¿½ Starting banner animation...`);
            innerBanner.classList.remove("-translate-y-full");
            innerBanner.classList.add("translate-y-0");
            console.log(
              `[LanguageDetection] ğŸ‰ Banner animated and now visible!`
            );
          } else {
            console.error(
              `[LanguageDetection] âŒ Inner banner #language-suggestion-banner not found!`
            );
          }
        }, 1500);

        console.log(
          `[LanguageDetection] â±ï¸ Banner will animate in 1.5 seconds...`
        );
      } else {
        console.error(
          `[LanguageDetection] âŒ ERROR: Banner element #language-banner-${suggestedLang} NOT FOUND in DOM!`
        );
      }
    } else {
      console.log(
        "[LanguageDetection] â„¹ï¸ No language suggestion needed (browser matches page)"
      );
    }
  });
</script>
