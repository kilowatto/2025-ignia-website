---
/**
 * ContactForm.astro
 *
 * PROPÓSITO:
 * Mini-formulario de contacto COMPACTO y DISCRETO integrado en el footer.
 * Diseño minimalista de una sola columna con campos inline cuando es posible.
 *
 * CARACTERÍSTICAS:
 * - Diseño compacto: título pequeño + 3 campos + botón
 * - localStorage: Previene múltiples envíos (30 días)
 * - Anti-bot: Honeypot + timestamp validation
 * - Estados: idle, validating, success, already_submitted
 *
 * CUMPLIMIENTO arquitecture.md:
 * - §2: Progressive enhancement (funciona sin JS básico)
 * - §5: Traducciones centralizadas (footer.contact_form.*)
 * - §7: Footer sticky (formulario discreto integrado)
 * - §8: Tailwind utilities exclusivamente
 *
 * @see src/scripts/contact-form.ts - Lógica cliente
 * @see src/i18n/es.json - Traducciones
 */
import { useTranslations } from "@/utils/i18n";

// Detección de idioma (patrón SitemapFooter)
const rawLocale = Astro.currentLocale || "en";
const supportedLocales = ["en", "es", "fr"] as const;
type Locale = (typeof supportedLocales)[number];
const locale = supportedLocales.includes(rawLocale as Locale)
  ? (rawLocale as Locale)
  : "en";

const t = await useTranslations(locale);
const translate = (key: string) => t(key, { locale });
---

<!-- Mini-formulario compacto y discreto -->
<div
  id="contact-form-container"
  class="w-full max-w-md mx-auto mt-8 mb-6"
  data-locale={locale}
>
  <!-- Estado: IDLE / VALIDATING -->
  <div id="form-wrapper">
    <h3 class="text-sm font-semibold text-white/90 mb-3 text-center">
      {translate("footer.contact_form.title")}
    </h3>

    <form id="contact-form" class="space-y-2.5" novalidate>
      <!-- Honeypot anti-bot -->
      <input
        type="text"
        name="website"
        id="website-field"
        class="hidden"
        tabindex="-1"
        autocomplete="off"
        aria-hidden="true"
      />

      <!-- Campos en una sola columna compacta -->
      <input
        type="text"
        id="name"
        name="name"
        required
        minlength="2"
        maxlength="100"
        placeholder={translate("footer.contact_form.fields.name.placeholder")}
        class="w-full px-3 py-2 text-sm rounded bg-white/10 border border-white/20 text-white placeholder:text-white/50 focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-transparent transition-all"
        aria-label={translate("footer.contact_form.fields.name.label")}
      />

      <input
        type="tel"
        id="phone"
        name="phone"
        required
        pattern="[+]?[0-9]{1,4}?[-.\s]?[(]?[0-9]{1,3}[)]?[-.\s]?[0-9]{1,4}[-.\s]?[0-9]{1,4}[-.\s]?[0-9]{1,9}"
        placeholder={translate("footer.contact_form.fields.phone.placeholder")}
        class="w-full px-3 py-2 text-sm rounded bg-white/10 border border-white/20 text-white placeholder:text-white/50 focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-transparent transition-all"
        aria-label={translate("footer.contact_form.fields.phone.label")}
      />

      <input
        type="email"
        id="email"
        name="email"
        required
        placeholder={translate("footer.contact_form.fields.email.placeholder")}
        class="w-full px-3 py-2 text-sm rounded bg-white/10 border border-white/20 text-white placeholder:text-white/50 focus:outline-none focus:ring-1 focus:ring-orange-500 focus:border-transparent transition-all"
        aria-label={translate("footer.contact_form.fields.email.label")}
      />

      <!-- Cloudflare Turnstile (opcional) -->
      <div id="turnstile-widget" class="flex justify-center"></div>

      <!-- Botón compacto -->
      <button
        type="submit"
        id="submit-button"
        class="w-full py-2 px-4 text-sm font-semibold bg-orange-600 hover:bg-orange-700 text-white rounded transition-colors focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 focus:ring-offset-[var(--color-secondary)] disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <span id="button-text"
          >{translate("footer.contact_form.button.send")}</span
        >
        <span id="button-spinner" class="hidden">
          <svg
            class="animate-spin -ml-1 mr-1.5 h-4 w-4 inline"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          {translate("footer.contact_form.button.sending")}
        </span>
      </button>
    </form>
  </div>

  <!-- Estado: SUCCESS (compacto) -->
  <div id="success-message" class="hidden text-center py-4">
    <div class="text-green-400 text-4xl mb-2">✅</div>
    <p class="text-sm font-semibold text-white mb-1">
      {translate("footer.contact_form.success.title")}
    </p>
    <p class="text-xs text-white/70">
      {translate("footer.contact_form.success.message")}
    </p>
  </div>

  <!-- Estado: ALREADY_SUBMITTED (compacto) -->
  <div id="already-submitted-message" class="hidden text-center py-4">
    <div class="text-white text-4xl mb-2">✅</div>
    <p class="text-sm font-semibold text-white mb-1">
      {translate("footer.contact_form.already_submitted.title")}
    </p>
    <p class="text-xs text-white/70">
      {translate("footer.contact_form.already_submitted.message")}
    </p>
  </div>
</div>

<!-- Script cliente -->
<script>
  import "../scripts/contact-form.ts";
</script>

<!-- Cloudflare Turnstile (opcional, defer) -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer
></script>
