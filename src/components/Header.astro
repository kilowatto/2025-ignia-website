---
/**
 * Header.astro
 * 
 * Componente principal de navegación del sitio Ignia Cloud.
 * Refactorizado para cumplir con arquitecture.md §2 (JS mínimo o nulo).
 * 
 * Funcionalidad:
 * - Mega-menu desktop con CSS puro (:hover, :focus-within)
 * - Mobile menu nativo sin JS bloqueante
 * - Progressive enhancement con script diferido (~30 líneas)
 * 
 * Performance:
 * - Eliminado: 250 líneas de JS bloqueante
 * - LCP esperado: -200-400ms
 * - INP esperado: -50-100ms
 * 
 * @see src/styles/global.css - Estilos CSS-only que manejan la funcionalidad core
 * @see src/scripts/header-progressive.ts - Script diferido para UX enhancements
 */

// LangSelect renders the language switcher used in both desktop and mobile menus.
import LangSelect from "./langSelect.astro";
// SearchBox provides the command-palette style search modal.
import SearchBox from "./SearchBox.astro";
// Import translation function from astro-i18n
import { t } from 'astro-i18n';

// Normalize the locale coming from Astro so every helper can rely on an allowed value.
const rawLocale = Astro.currentLocale || "es";
const supportedLocales = ["en", "es", "fr"] as const;
type Locale = (typeof supportedLocales)[number];
const locale = supportedLocales.includes(rawLocale as Locale)
  ? (rawLocale as Locale)
  : "es";

// Helper function to translate with locale
const translate = (key: string) => t(key, undefined, { locale });

// Prefix internal links with the current locale (except for English which lives at the root).
const ensureLocalePath = (href: string) => {
  if (!href.startsWith("/")) return href;
  const trimmed = href.replace(/^\/+/u, "");
  if (locale === "en") {
    return `/${trimmed}`;
  }
  return `/${locale}/${trimmed}`;
};

type NavItem = {
  href: string;
  title: string;
  description: string;
};

type NavSection = {
  id: string;
  href: string;
  label: string;
  summary: string;
  items: NavItem[];
};

type NavItemConfig = {
  key: string;
  href: string;
};

type NavSectionConfig = {
  id: string;
  href: string;
  items: NavItemConfig[];
};

// Mega-menu definition for the desktop experience; each section becomes a hoverable column.
// NOTA: Las rutas ahora se obtienen desde i18n (arquitecture.md §5 - Centralización Obligatoria)
// Esto permite mantener URLs localizadas por idioma sin hardcodear rutas en el código.
const navConfig: NavSectionConfig[] = [
  {
    id: 'solutions',
    href: translate('routes.solutions.base'),
    items: [
      { key: 'nocaas', href: translate('routes.solutions.nocaas') },
      { key: 'privateCloudService', href: translate('routes.solutions.privateCloudService') },
      { key: 'privateCloudOnPremise', href: translate('routes.solutions.privateCloudOnPremise') },
      { key: 'bcpDraas', href: translate('routes.solutions.bcpDraas') },
      { key: 'kubernetesDevops', href: translate('routes.solutions.kubernetesDevops') },
      { key: 'secureWorkloadHosting', href: translate('routes.solutions.secureWorkloadHosting') },
      { key: 'complianceCloud', href: translate('routes.solutions.complianceCloud') },
      { key: 'regulatoryBackupArchival', href: translate('routes.solutions.regulatoryBackupArchival') },
    ],
  },
  {
    id: 'products',
    href: translate('routes.products.base'),
    items: [
      { key: 'virtualMachines', href: translate('routes.products.virtualMachines') },
      { key: 'kubernetesService', href: translate('routes.products.kubernetesService') },
      { key: 'blockStorage', href: translate('routes.products.blockStorage') },
      { key: 'objectStorage', href: translate('routes.products.objectStorage') },
      { key: 'cloudBackup', href: translate('routes.products.cloudBackup') },
      { key: 'cloudFirewall', href: translate('routes.products.cloudFirewall') },
      { key: 'dns', href: translate('routes.products.dns') },
      { key: 'loadBalancer', href: translate('routes.products.loadBalancer') },
    ],
  },
  {
    id: 'ai',
    href: translate('routes.ai.base'),
    items: [
      { key: 'llmHosting', href: translate('routes.ai.llmHosting') },
      { key: 'ragBlueprints', href: translate('routes.ai.ragBlueprints') },
      { key: 'copilotStudio', href: translate('routes.ai.copilotStudio') },
      { key: 'mlopsMonitoring', href: translate('routes.ai.mlopsMonitoring') },
    ],
  },
  {
    id: 'services',
    href: translate('routes.services.base'),
    items: [
      { key: 'managedIt', href: translate('routes.services.managedIt') },
      { key: 'cloudConsulting', href: translate('routes.services.cloudConsulting') },
      { key: 'supportCenter', href: translate('routes.services.supportCenter') },
    ],
  },
];

const navSections: NavSection[] = navConfig.map((section) => ({
  id: section.id,
  href: section.href,
  label: translate(`header.sections.${section.id}.label`),
  summary: translate(`header.sections.${section.id}.summary`),
  items: section.items.map((item) => ({
    href: item.href,
    title: translate(`header.sections.${section.id}.items.${item.key}.title`),
    description: translate(`header.sections.${section.id}.items.${item.key}.description`),
  })),
}));

// ARIA labels retrieved from translations.
const navAriaLabel = translate('header.nav.aria.desktop');
const mobileAriaLabel = translate('header.nav.aria.mobile');
const toggleMenuLabel = translate('header.nav.toggle');

type MobileLink = {
  href: string;
  label: string;
};

// Mobile menu uses a flattened list of top-level destinations plus key utility pages.
// NOTA: Rutas centralizadas desde i18n para consistencia multi-idioma
const mobileLinks: MobileLink[] = [
  ...navSections.map((section) => ({
    href: ensureLocalePath(section.href),
    label: section.label,
  })),
  {
    href: ensureLocalePath(translate('routes.common.blog')),
    label: translate('header.nav.mobile.blog'),
  },
  {
    href: ensureLocalePath(translate('routes.common.contact')),
    label: translate('header.nav.mobile.contact'),
  },
];

// Helper used by the template when linking into nested locale-specific pages.
const localeHref = (href: string) => ensureLocalePath(href);
const logoAlt = translate('header.logo_alt');
const socialAriaLabel = translate('header.nav.aria.social');
const socialLabels = {
  linkedin: translate('header.nav.social.linkedin'),
  whatsapp: translate('header.nav.social.whatsapp'),
};
---

<!-- Header: main site navigation with locale-aware links; Tailwind utilities handle spacing, blur, and shadows -->
 <!-- el header tiene sombra color #f36b1c -->
<header
  class="relative z-50 w-full border-b border-slate-100 bg-white/85 shadow-md shadow-[#f36b1c] backdrop-blur supports-[backdrop-filter]:bg-white/70"
>
  <!-- Wrapper: aligns logo, desktop navigation, and utility actions -->
  <div class="mx-auto flex max-w-7xl flex-col px-4 py-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between gap-4 lg:gap-6">
      <!-- Logo lockup: routes to locale-aware home page -->
      <a
        href={locale === "en" ? "/" : `/${locale}/`}
        class="block shrink-0"
        aria-label={logoAlt}
      >
        <!-- 
          Logo como LCP candidate: 
          - fetchpriority="high" para priorizar carga
          - Sin loading="lazy" (está above the fold)
          - decoding="async" para no bloquear rendering
          
          Cumplimiento arquitecture.md §14: LCP < 2.5s
        -->
        <img
          src="/logo.svg"
          alt={logoAlt}
          class="h-12 w-auto"
          fetchpriority="high"
          decoding="async"
        />
      </a>
      <!-- Desktop mega-menu: only visible from extra-large breakpoints (≥1280px) -->
      <div class="hidden flex-1 items-center justify-center xl:flex">
        <nav class="nav-ignia" aria-label={navAriaLabel}>
          <ul class="nav-ignia__list">
            {
              navSections.map((section) => (
                <li class="nav-ignia__item">
                  <!-- Trigger: funciona con :hover y :focus-within (CSS puro) -->
                  <button
                    type="button"
                    class="nav-ignia__trigger"
                    aria-haspopup="true"
                    aria-expanded="false"
                    aria-label={section.label}
                  >
                    {section.label}
                    <svg
                      class="nav-ignia__trigger-icon"
                      viewBox="0 0 16 16"
                      aria-hidden="true"
                    >
                      <path
                        d="M3.22 5.22a.75.75 0 0 1 1.06 0L8 8.94l3.72-3.72a.75.75 0 0 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L3.22 6.28a.75.75 0 0 1 0-1.06z"
                        fill="currentColor"
                      />
                    </svg>
                  </button>
                  <!-- Mega panel: se muestra con CSS :hover y :focus-within del li padre -->
                  <div class="nav-ignia__panel">
                    <div class="nav-ignia__summary">
                      <h3 class="nav-ignia__summary-title">
                        {section.label}
                      </h3>
                      <p class="nav-ignia__summary-text">
                        {section.summary}
                      </p>
                      <a
                        href={localeHref(section.href)}
                        class="nav-ignia__summary-link"
                      >
                        {translate('header.sections.explore_all')}
                      </a>
                    </div>
                    <ul class="nav-ignia__panel-list">
                      {section.items.map((item) => (
                        <li class="nav-ignia__panel-item">
                          <a
                            href={localeHref(item.href)}
                            class="nav-ignia__panel-link"
                          >
                            <span class="nav-ignia__panel-title">
                              {item.title}
                            </span>
                            <span class="nav-ignia__panel-description">
                              {item.description}
                            </span>
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                </li>
              ))
            }
          </ul>
        </nav>
      </div>
      <!-- Utility bar: search shortcut, language selector, and social icons -->
      <div class="flex items-center gap-2 lg:gap-3 flex-shrink-0">
        <!-- Desktop search shortcut: hidden on small screens -->
        <div class="hidden w-56 lg:block lg:flex-shrink-0">
          <SearchBox />
        </div>
        <!-- Desktop language selector: mobile version lives inside the flyout -->
        <div class="hidden lg:block lg:flex-shrink-0">
          <LangSelect />
        </div>
        <!-- Social icons: persistent access to LinkedIn and WhatsApp -->
        <div
          class="nav-ignia__social nav-ignia__social--header"
          aria-label={socialAriaLabel}
        >
          <a
            href="https://www.linkedin.com/company/ignia-cloud/"
            class="nav-ignia__social-link nav-ignia__social-link--linkedin"
            target="_blank"
            rel="noopener noreferrer"
          >
            <span class="sr-only">{socialLabels.linkedin}</span>
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M20.45 20.45h-3.4v-5.34c0-1.27-.02-2.91-1.77-2.91-1.77 0-2.04 1.38-2.04 2.81v5.44h-3.39V9h3.25v1.56h.05c.45-.85 1.56-1.74 3.21-1.74 3.43 0 4.06 2.26 4.06 5.19v6.44ZM5.34 7.43a1.97 1.97 0 1 1 0-3.94 1.97 1.97 0 0 1 0 3.94ZM7.05 20.45H3.62V9h3.43v11.45Z"
                fill="currentColor"></path>
            </svg>
          </a>
          <a
            href="https://wa.me/525569527498"
            class="nav-ignia__social-link nav-ignia__social-link--whatsapp"
            target="_blank"
            rel="noopener noreferrer"
          >
            <span class="sr-only">{socialLabels.whatsapp}</span>
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M12 2a9.94 9.94 0 0 0-8.51 15.3L2 22l4.83-1.45A9.94 9.94 0 1 0 12 2Zm0 17.8a7.8 7.8 0 0 1-3.98-1.1l-.28-.17-2.86.86.92-2.77-.18-.29A7.8 7.8 0 1 1 12 19.8Zm4.47-5.55c-.25-.12-1.46-.72-1.68-.8-.22-.08-.38-.12-.54.12-.16.23-.62.77-.76.92-.14.16-.28.18-.53.06-.25-.12-1.06-.39-2.01-1.24-.74-.66-1.24-1.47-1.39-1.72-.15-.26-.02-.4.1-.52.11-.11.25-.28.37-.42.12-.14.16-.23.24-.38.08-.15.04-.29-.02-.41-.06-.12-.54-1.28-.74-1.76-.2-.48-.4-.41-.54-.42h-.46c-.16 0-.41.06-.63.3-.22.23-.83.81-.83 1.98 0 1.17.85 2.3.97 2.46.12.16 1.66 2.53 4.02 3.55.56.24 1 .38 1.34.49.56.18 1.07.15 1.47.09.45-.07 1.46-.6 1.67-1.18.21-.58.21-1.07.15-1.18-.06-.11-.23-.17-.48-.3Z"
                fill="currentColor"></path>
            </svg>
          </a>
        </div>
        <!-- Mobile toggle button: reveals compact menu and utilities on smaller screens -->
        <button
          id="mobile-menu-button"
          type="button"
          class="inline-flex h-11 w-11 items-center justify-center rounded-full border border-slate-200 text-slate-600 transition hover:border-orange-300 hover:text-orange-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-500 xl:hidden"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <span class="sr-only">{toggleMenuLabel}</span>
          <svg
            class="h-6 w-6"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            data-icon="open"
            aria-hidden="true"
          >
            <path d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg
            class="hidden h-6 w-6"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            data-icon="close"
            aria-hidden="true"
          >
            <path d="M6 6l12 12M18 6l-12 12"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  <!-- Mobile flyout menu: toggled via hamburger button -->
  <div id="mobile-menu" class="nav-ignia__mobile-menu" hidden>
    <!-- Mobile primary navigation links -->
    <nav aria-label={mobileAriaLabel}>
      <ul class="nav-ignia__mobile-list">
        {
          mobileLinks.map((link) => (
            <li>
              <a href={link.href} class="nav-ignia__mobile-link">
                {link.label}
              </a>
            </li>
          ))
        }
      </ul>
    </nav>
    <div class="nav-ignia__mobile-search">
      <SearchBox />
    </div>
    <div class="nav-ignia__mobile-lang">
      <LangSelect />
    </div>
    <div class="nav-ignia__mobile-social" aria-label={socialAriaLabel}>
      <a
        href="https://www.linkedin.com/company/ignia-cloud/"
        class="nav-ignia__social-link nav-ignia__social-link--linkedin"
        target="_blank"
        rel="noopener noreferrer"
      >
        <span class="sr-only">{socialLabels.linkedin}</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M20.45 20.45h-3.4v-5.34c0-1.27-.02-2.91-1.77-2.91-1.77 0-2.04 1.38-2.04 2.81v5.44h-3.39V9h3.25v1.56h.05c.45-.85 1.56-1.74 3.21-1.74 3.43 0 4.06 2.26 4.06 5.19v6.44ZM5.34 7.43a1.97 1.97 0 1 1 0-3.94 1.97 1.97 0 0 1 0 3.94ZM7.05 20.45H3.62V9h3.43v11.45Z"
            fill="currentColor"></path>
        </svg>
      </a>
      <a
        href="https://wa.me/525569527498"
        class="nav-ignia__social-link nav-ignia__social-link--whatsapp"
        target="_blank"
        rel="noopener noreferrer"
      >
        <span class="sr-only">{socialLabels.whatsapp}</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M12 2a9.94 9.94 0 0 0-8.51 15.3L2 22l4.83-1.45A9.94 9.94 0 1 0 12 2Zm0 17.8a7.8 7.8 0 0 1-3.98-1.1l-.28-.17-2.86.86.92-2.77-.18-.29A7.8 7.8 0 1 1 12 19.8Zm4.47-5.55c-.25-.12-1.46-.72-1.68-.8-.22-.08-.38-.12-.54.12-.16.23-.62.77-.76.92-.14.16-.28.18-.53.06-.25-.12-1.06-.39-2.01-1.24-.74-.66-1.24-1.47-1.39-1.72-.15-.26-.02-.4.1-.52.11-.11.25-.28.37-.42.12-.14.16-.23.24-.38.08-.15.04-.29-.02-.41-.06-.12-.54-1.28-.74-1.76-.2-.48-.4-.41-.54-.42h-.46c-.16 0-.41.06-.63.3-.22.23-.83.81-.83 1.98 0 1.17.85 2.3.97 2.46.12.16 1.66 2.53 4.02 3.55.56.24 1 .38 1.34.49.56.18 1.07.15 1.47.09.45-.07 1.46-.6 1.67-1.18.21-.58.21-1.07.15-1.18-.06-.11-.23-.17-.48-.3Z"
            fill="currentColor"></path>
        </svg>
      </a>
    </div>
</div>
</header>

<!-- 
  Progressive enhancement script: cargado con defer para no bloquear el hilo principal.
  Solo agrega funcionalidad NO ESENCIAL (cerrar menú mobile, keyboard Escape).
  La funcionalidad core (hover, focus) es manejada por CSS puro.
  
  Cumplimiento arquitecture.md §2: "JavaScript debe ser aislado, diferido y sólo en la página que lo requiera"
-->
<script src="/scripts/header-progressive.js" defer></script>

